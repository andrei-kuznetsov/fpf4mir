import ru.spbstu.icc.kspt.kuznetsov.fpf4mir.core.facts.*;
import ru.spbstu.icc.kspt.kuznetsov.fpf4mir.core.facts.generic.*;
import ru.spbstu.icc.kspt.kuznetsov.fpf4mir.core.facts.deploy.*;
import ru.spbstu.icc.kspt.kuznetsov.fpf4mir.core.requestfacts.*;
import ru.spbstu.icc.kspt.kuznetsov.fpf4mir.core.facts.build.*;
import ru.spbstu.icc.kspt.kuznetsov.fpf4mir.core.facts.build.maven.*;
import ru.spbstu.icc.kspt.kuznetsov.fpf4mir.core.actionfacts.*;


// #################################### Input parameters #######################################
rule "Populate input parameters for GuessRunExecutableActivity from ReqGuessRunExecutable"
	when
		request 'ReqGuessRunExecutable'
		activity for request
		request inputs (
		    input 'FolderArtifactAlias'
>		)
	then
		add activity fact from request input
end

// ----------------------------------- Output parameters ---------------------------------------

rule "GuessRunExecutable Request Status - FileArtifactList"
	when
		request 'ReqGuessRunExecutable'
		activity for request
		activity succeeded
		$list : ExecFileArtifactList for activity
	then
		set request status succeeded
		add request status parameter $list as ExecFileArtifactListAlias
end

// #############################################################################################

rule "Single file is always considered as executable"
	when
		activity 'GuessRunExecutableActivity'
>		FolderArtifact( activity == $activity, $flist: getFileArtifactListForPattern("**\\*"), $flist.size == 1) 
	then
		insert artifact '$flist.get(0)' as 'ExecArtifactCandidate'
end

rule "sh,exe,jar,py files are executable"
	when
		activity 'GuessRunExecutableActivity'
>		FolderArtifact( activity == $activity, $flist:getFileArtifactListForPattern(
>			"**\\*.sh","**\\*.exe","**\\*.jar","**\\*.py") )
	then
>		for (FileArtifact i : $flist)
			insert artifact 'i' as 'ExecArtifactCandidate'
end

rule "List ExecArtifact candidates"
	salience -1 // shall be less than the salience of rules about ExecArtifactCandidate
	when
		activity 'GuessRunExecutableActivity'
>		$candidates : java.util.LinkedList( size > 1 ) from collect( ExecArtifactCandidate(activity == $activity) )
	then
		insert artifact '$candidates' as 'ExecFileArtifactList'
		activity succeeded
end
